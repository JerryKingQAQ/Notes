# 计算机网络

## 概论

### 概述

三大类网络：电信网络、有线电视网络、计算机网络。

 Internet：因特网（理论译名）、互联网（流行译名）

- internet（互联网或互连网）：通用名词，它泛指由多个计算机网络互连而成的网络。
- Internet（因特网）：专用名词，特指采用 TCP/IP 协议的互联网络。区别：后者实际上是前者的双向应用

计算机网络由**节点**和**链路**组成。

- 1969-1990 ARPANET (1983互联网诞生, TCP/IP) 
- 1985-1993 三级结构(主干网、地区网、校园/企业网) 
- 1993-现在 主干、地区和本地ISP(互联网服务提供者) (形成多层次ISP结构的Internet)



### 组成

互联网按工作部分划分为边缘部分、核心部分。

在边缘部分，主机=端系统，拥有者可以是个人、单位、ISP。

端系统通信方式：C/S，P2P(Peer to Peer)

核心部分最重要功能：**分组转发**。路由器任务：转发收到的分组，实现分组交换。

分组交换技术：

- 电路交换：线的数量是 C2n，用交换机可以减少。必须一直占线。建立-通话-释放。
-  分组交换：存储转发技术。数据段加首部(/包头)成分组(/包)。每个分组独立选择路径。可以不先建立连接。可靠协议。但排队延迟、不保证带宽、增加开销(包头、路由器暂存和维护转发表)。 要点：报文分组，加首部；经路由器储存转发；在目的地合并 
- 报文交换：存储转发原理，时延长。不需要预先分配带宽。

优缺点比较：（1）电路交换：端对端通信质量因约定了通信资源获得**可靠保障**，对连续传送大量数据效率高。（2）报文交换：无须预约传输带宽，动态逐段利用传输带宽对**突发式数据通信效率高，通信迅速。** （3）分组交换：具有报文交换之高效、迅速的要点，且各**分组小，路由灵活，网络生存性能好。**



### 类别

计算机网络：由一些通用的、可编程的硬件互连而成的，这些硬件并非专门用于实现某一特定目的，可编程的硬件可以传送多种不同类型的数据（有CPU,中央处理器）。

按照网络作用范围：广域网(远程网)WAN，城域网MAN，局域网LAN，个人区域网(个域网)PAN。多处理机系统不是网络。广域网是Internet核心网。

按使用者(范围)划分：公用网(公众网)、专用网。

逻辑功能上，分为通信子网(组成：通信硬件、通信软件)和资源子网。

计算机网络的拓扑结构是指：忽略了设备和线路的大小、重量等物理性质，把它们抽象成点和线，仅仅研究点、线、面的关系，从而简化了研究的过程。拓扑结构划分：星形、树形、总线、环形、网状。

同通信能：资源共享计算机网络、分布式计算机网络和远程通信网络



### 性能

速率(数据率，比特率)，单位bit/s。 1 Byte=8 bit。额定速率：绝对上限值。
$$
K=2^{10}\quad M=2^{20}\quad G=2^{30}
$$
带宽(bandwidth)，频带宽度(频域, 赫, Hz)或最高数据率(时域, bit/s)。

吞吐量(throughput)，实际单位时间通过的数据量。每秒字节/帧数。

时延(delay，延迟，迟延)。哪一个主导具体问题具体分析。

- 发送时延(传输时延)：主机/路由器发送数据帧第一个比特到最后一个完毕的时间
- 传播时延：
- 处理时延：主机/路由器处理收到的分组用时
- 排队时延：分组在路由器输入输出队列排队等待时长。丢失等于无限

时延带宽积：传播时延X带宽，bit为单位的链路长度。



### 体系结构

| OSI        | TCP/IP            | 五层       |
| ---------- | ----------------- | ---------- |
| 应用层     | 应用层            | 应用层     |
| 表示层     |                   |            |
| 会话层     |                   |            |
| 运输层     | 运输层            | 运输层     |
| 网络层     | 网络层            | 网络层     |
| 数据链路层 | 链路层/网络接口层 | 数据链路层 |
| 物理层     |                   | 物理层     |

**应用层：**应用层是最高层，它为用户提供网络服务和应用程序的接口。应用层协议包括HTTP、FTP、SMTP、DNS等，它们定义了应用程序如何进行通信和数据传输。

**传输层：**传输层主要负责提供可靠的数据传输服务，它通过端口号来识别不同的应用程序。传输层协议包括TCP和UDP，TCP提供可靠的连接导向的传输服务，UDP则提供不可靠的无连接传输服务。

**网络层：**网络层负责将数据包从源主机传输到目的主机，它通过IP地址和路由选择算法来实现数据包的传输。网络层协议包括IP协议和ICMP协议等。

**数据链路层：**数据链路层主要负责将数据帧从一个节点传输到相邻节点，它通过物理地址（MAC地址）来识别网络上的设备。数据链路层协议包括以太网协议、PPP协议等。

**物理层：**物理层负责处理物理媒介上的传输，它将比特流转换成信号，以便在传输介质上传输。物理层协议包括网线、光纤等。



## 物理层

物理层考虑的是怎样才能在**连接**各种计算机的**传输媒体上传输数据比特流**，而**不是指具体的传输媒体**。

物理层的作用是要尽可能地**屏蔽掉传输媒体和通信手段的差异**。即不论用什么接口都能通信。

用于物理层的协议也常称为物理层**规程**。

物理层的主要任务是**与传输接口有关**的一些特性：

- **机械特性**：指明接口所用接线器的形状和尺寸、引脚数目和排列、固定和锁定装置等。平时常见的各种规格的接插件都有严格的标准化的规定。
- **电气特性**：指明在接口电缆的各条线上出现的电压的范围。
- **功能特性**：指明某条线上出现的某一电平的电压的意义。
- **过程特性**：指明对于不同功能的各种可能事件的出现顺序。

数据在计算机内部采用并行运输的方式：多个比特同时传输。

数据在通信线路(传输媒体)上使用串行运输的方式：即逐个比特按照时间顺序传输。



### 数据通信的基础知识

#### 数据通信系统的模型

一个数据通信系统可划分为三大部分，即**源系统**（或发送端、发送方）、**传输系统**（或传输网络）和**目的系统**（或接收端、接收方）。又称为：信源、通信媒体、信宿。

在上图中：**调制**认为是把**数字信号转换为模拟信号**的过程，而**解调**是把**模拟信号转换为数字信号**的过程。

老师课堂解释的**调制**：把信号转化为**适合在信道上传输的信号**。

一些常用术语及解释：

| 术语     | 解释                                                         |
| -------- | ------------------------------------------------------------ |
| 数据     | 运送消息的实体                                               |
| 信号     | 数据的电气的或电磁的表现                                     |
| 模拟信号 | 代表消息的参数的取值是连续的                                 |
| 数字信号 | 代表消息的参数的取值是离散的                                 |
| 码元     | 在使用时间域（或简称为时域）的波形表示数字信号时，代表不同离散数值的基本波形。 |



### 信道的基本概念

| 概念                       | 解释                                                         |
| -------------------------- | ------------------------------------------------------------ |
| 信道                       | 一般用来表示向某一个方向传递信息的媒体                       |
| 单向信道（单工信道）       | 只能有一个方向的通信而没有反方向的交互                       |
| 双向交替通信（半双工通信） | 通信的双方都可以发送信息，但不能双方同时发送（当然也就不能同时接收） |
| 双向同时通信（全双工通信） | 通信的双方可以同时发送和接收信息                             |

**基带信号**（即基本频带信号）——来自信源的信号。计算机输出的代表各种文字或图像文件的**数据信号**（数字信号）都属于基带信号。

调制分为两大类：

- 基带调制：仅对基带信号的波形进行变换，使它能够与信道特征相适应。**变换后的信号仍然是基带信号**。把这种过程称为**编码**。把数字信号转换为另一种形式的数字信号。
- 带通调制：使用**载波进行调制**，把基带信号的频率范围搬移到较高的频段，并**转换为模拟信号**，这样就能够更好地在模拟信道中传输。

**带通信号**：经过**载波调制**后的信号。

常用的编码方式：

| 编码方法         | 表示方法                                                     |
| ---------------- | ------------------------------------------------------------ |
| 不归零制         | 正电平代表1，负电平代表0                                     |
| 归零制           | 正脉冲代表1，负脉冲代表0                                     |
| ⭐曼彻斯特编码    | 高—>低代表1，低—>高代表0。但也可以反过来定义                 |
| 差分曼彻斯特编码 | 前一位后半和后一位前半不同表示0。前一位后半和后一位前半相同表示1 |



基本的带通调制方法：

| 方法                   | 含义                                   |
| ---------------------- | -------------------------------------- |
| 调幅(AM)/幅移键控(ASK) | 载波的**振幅**随基带数字信号而变化     |
| 调频(FM)/频移键控(FSK) | 载波的**频率**随基带数字信号而变化     |
| 调相(PM)/相移键控(PSK) | 载波的**初始相位**随基带数字信号而变化 |



### 信道的极限容量

任何实际的信道都不是理想的，在传输信号时会产生各种**失真**以及带来多种干扰。

从概念上讲，限制码元在信道上的传输速率的因素有以下两个：

- **信道能够通过的频率范围—>带宽**
- 信噪比

#### 奈氏准则

所谓**带宽就是指能通过的频率范围**。单位是Hz

**奈氏准则：**

- **假定的理想条件下**，为了避免码间串扰，**码元的传输速率的上限值**。
- 理想低通信道的最高码元传输速率 = **2W** (码元/秒=**波特**)
- **W 是理想低通信道的带宽**，单位为赫(Hz)。信道的**频带越宽**，也就是能够通过的信号高频分量越多，就可以用更高的速率传送码元而不出现码元串扰。

**比特率和波特率的关系：**

- 比特率是指单位时间内所传输的**二进制代码**的有效位数，单位是**比特/秒(bps)**。
- 波特率是指每秒**传送的波形**的个数，单位是**波特(baud)**。
- 比特率和波特率之间的换算关系如下：`比特率 = 波特率×log2N`，其中N为码元所表示的有效状态数。



#### 信噪比

- 信噪比就是信号的平均功率和噪声的平均功率之比。常记为**S/N**，并用**分贝(dB)**作为度量单位。即：`S/N(dB) = 10log10(S/N)（dB）`，这里要注意，**信噪比的意思是S/N**，但是用**分贝作度量单位**的时候要把信噪比用公式`10log10(S/N)（dB）`得到。

- 带宽受限且有高斯白噪声干扰的信道的**极限、无差错的信息传输速率C**（**香农公式**）可表达为：`C = W log2(1+S/N) (bit/s)`。其中W 为信道的带宽（以 Hz 为单位）；S 为信道内所传信号的平均功率；N 为信道内部的高斯噪声功率。



#### 香农公式

`C = W log2(1+S/N) (bit/s)`

香农公式表明：

- 信道的带宽或信道中的信噪比越大，则信息的极限传输速率就越高。
- **只要信息传输速率低于信道的极限信息传输速率，就一定可以找到某种办法来实现无差错的传输。**
- 若信道带宽 W 或信噪比 S/N 没有上限（当然实际信道
  不可能是这样的），则信道的极限信息传输速率 C 也
  就没有上限。
- 实际信道上能够达到的信息传输速率要比香农的极限传输速率低不少。



### 传输媒体

传输媒体也称为传输介质或传输媒介，**它并不属于物理层**

传输媒体分为两大类，即**导引型传输媒体**和**非导引型传输媒体**。

- 导引型传输媒体中，电磁波被导引沿着固体媒体（铜线或光纤）传播。
- 非导引型传输媒体就是指自由空间，在非导引型传输媒体中，电磁波的传输称为无线传输。

#### 导引型传输媒体

##### 双绞线

- 最常用的传输媒体
- 模拟传输和数字传输都可以使用双绞线，通信距离一般为几到十几公里。
- **屏蔽双绞线STP**，带金属屏蔽层。
- 无屏蔽双绞线UTP
- 导线相互缠绕可以降低电磁干扰

##### 同轴电缆

- 同轴电缆具有很好的抗干扰特性，被广泛用于传输较高速率的数据。
- 同轴电缆的带宽取决于电缆的质量。

##### 光纤

- 多模光纤：纤芯直径较大，可同时传输多条光线；使用发光二极管作为光源。

- 单模光纤：纤芯直径较小，一次仅能传输一条光线；使用激光作为光源。

与单模光纤相比，多模光纤传输速率低，距离短（2km），整体的传输性能差，成本较低；一般用于建筑物内或地理位置相邻的环境，主要用于局域网。单模光纤通常用作楼间的连接或广域网连接。

光纤优点：

(1) 通信容量非常大。

(2) 传输损耗小，中继距离长。

(2) 抗雷电和电磁干扰性能好。

(3) 无串音干扰，保密性好。

(4) 体积小，重量轻。



#### 非导引型传输媒体

- 将自由空间称为“非导引型传输媒体”

##### 短波通信

短波通信（即高频通信）主要是靠电离层的反射，但电离层的不稳定所产生的衰落现象和电离层反射所产生的多径效应，使短波信道的通信质量较差，传输速率低。

##### 微波通信

微波在空间主要是直线传播。

传统微波通信有两种方式：

- 地面微波中继通信

- 卫星通信



### 信道复用技术

包括频分复用、时分复用、统计时分复用、波分复用、码分复用

复用允许用户使用一个**共享**信道进行通信，**降低成本，提高利用率**。

**多个码片代表一个比特。**



#### 频分复用FDM

- 将整个带宽分为多份，用户在分配到一定的频带后，在通信过程中自始至终都占用这个频带。
- 频分复用的所有用户在**同样的时间占用不同的带宽资源**（请注意，这里的“带宽”是频率带宽而不是数据的发送速率）。



#### 时分复用TDM

- 时分复用则是将时间划分为一段段等长的时分复用帧（TDM 帧）。每一个时分复用的用户在每一个 TDM帧中占用固定序号的时隙。
- 每一个用户所占用的时隙是周期性地出现（其周期就是 TDM 帧的长度）。
- TDM 信号也称为等时(isochronous)信号。
- 时分复用的所有用户是**在不同的时间占用同样的频带宽度**。

使用时分复用系统传送计算机数据时，由于**计算机数据的突发性质**，用户对分配到的子信道的利用率一般是不高的。



#### 统计时分复用STDM

STDM 帧不是固定分配时隙，而是**按需动态地分配时隙**。因此统计时分复用**可以提高线路的利用率**。

- 在每个时隙中**需要有用户的地址信息**。
- 集中器**能正常工作的前提是假定各用户都是间歇地工作**。



#### 波分复用WDM



#### 码分复用CDM

- 码分复用是一种**共享信道**的方法。当码分复用信道为多个不同地址的用户所共享时，就称为**码分多址**CDMA。
- 各用户使用经过特殊挑选的**不同码型**，因此彼此不会造成干扰。
- 这种系统发送的信号**有很强的抗干扰能力**，其频谱类似于白噪声，不易被敌人发现。

##### 码片序列

每一个比特时间划分为 m 个短的间隔，称为**码片**。每个站被指派一个唯一的 m bit 码片序列。

将**码片中的0记为-1**，将**码片中的1记为+1**



#### CDMA的重要特点

每个站分配的码片序列不仅**必须各不相同**，并且还必须**互相正交** (orthogonal)。

两个不同站的码片序列正交，就是向量 S 和T的规格化内积 (inner product) 等于 0，**注意要求平均**。

- 任何一个码片向量和该码片向量自己的规格化内积都是 1
- 一个码片向量和该码片反码的向量的规格化内积值是 –1 

当**S站发送比特1（码片序列）时，在X站计算内积的结果是+1**；当**S站发送比特0（码片序列的反码）时，内积的结果是-1**。

**所有站收到的都是叠加的信号**。

当接收S站发送的信号时，就用**S站的码片序列**与**收到的信号求规格化内积**。S·S~x~就是S站发送的数据比特,因为在计算规格化内积时,或者都是+1,或者都是-1



### 数字传输系统

与模拟通信相比，数字通信无论是在传输质量上还是经济上都有明显的优势。

目前，长途干线大都采用**时分复用的脉码调制PCM** 的**数字传输**方式。

脉码调制一般包括三个过程：**采样、量化和编码**。

旧的数字传输系统存在许多缺点：

- **速率标准不统一**
- **不是同步传输**

**同步光纤网 SONET**

- 对电信信号称为第 1 级同步传送信号 STS-1
- 对光信号则称为第 1 级光载波 OC-1

**同步数字系列 SDH**

一般可认为 SDH 与 SONET 是同义词。

其主要不同点是：SDH 的第 1 级同步传递模块，即 STM-1，相当于 SONET 体系中的 OC-3 速率。

SONET / SDH 标准的意义：第一次真正**实现了数字传输体制上的世界性标准**。



## 数据链路层

**链路(link)**是一条无源的点到点的物理线路段，中间没有任何其他的交换结点。

本章的重点内容：

- 数据链路层的点对点信道与PPP协议、广播信道与CSMA/CD协议
- 三个基本问题：**封装成帧、透明传输、差错检测**
- 以太网MAC层的硬件地址
- 适配器、转发器、集线器、网桥、以太网交换机

数据链路层的协议数据单元——**帧**



### 三个基本问题

#### 封装成帧

封装成帧 (framing) 就是在一段数据的前后分别添加首部和尾部，然后就构成了一个帧。确定帧的界限。

![image-20230418201716038](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230418201716038.png)



#### 透明传输

当数据部分是**非ASCII码**时，如果数据中的某个字节恰好和SOH或EOT这种控制字符一样，链路层就会错误地“找到帧地边界”

![image-20230419194356318](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230419194356318.png)

**解决办法：字节填充**

在发送端地数据链路层地控制字符前面**插入一个转义字符**“ESC”

如果转义字符也出现在数据当中，那么应在转义字符前面插入一个转义字符 ESC。当接收端收到连续的两个转义字符时，就删除其中前面的一个。



#### 差错检测

在传输过程中可能会产生比特差错：1 可能会变 成 0 而 0 也可能变成 1。

在一段时间内，传输错误的比特占所传输比特总数的比率称为**误码率** BER (Bit Error Rate)。

##### 循环冗余检验

在数据链路层传送的帧中，广泛使用了循环冗余检验 CRC 的检错技术。

在发送端，先把数据划分为组。假定每组 k 个比特。假设待传送的一组数据 M = 101001（现在 k = 6）。我们在 M 的后面再添加供差错检测用**的 n 位冗余码**一起发送。

![image-20230419195625607](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230419195625607.png)

![image-20230419195745546](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230419195745546.png)

![image-20230419195820598](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230419195820598.png)

在**数据后面添加上的冗余码**称为**帧检验序列 FCS** (Frame Check Sequence)。

循环冗余检验 CRC 和帧检验序列 FCS 并不等同。

- CRC 是一种常用的检错方法，而 FCS 是添加在数据后面的冗余码。
- FCS 可以用 CRC 这种方法得出，但 CRC 并非用来获得 FCS 的唯一方

##### 除数P的表示

一种较为方便的方法是用生成多项式来表示除数P。

使用
$$
P(X)=X^{3}+X^{2}+1
$$
表示除数P=1101（使用系数）

##### CRC校验方式

把接收到的每一帧都除以同样的除数P，然后检查得到余数R。

- 若R=0，则判定这个帧没有差错，就接受
- 若R≠0，则判定这个帧有差错，就丢弃
- 但是这种方式并不能确定究竟时哪一个或哪几个比特出现了差错

仅用循环冗余检验 CRC 差错检测技术只能做到无差错接受 (accept)

也就是说：“凡是接收端数据链路层接受的帧都没有传输差错”（有差错的帧就丢弃而不接受）。 

要做到“可靠传输”（**即发送什么就收到什么**）就必须再加上**确认和重传机制**



### 数据链路层的信道

- 点对点信道  一对一
- 广播信道  一对多

#### PPP协议 （点对点信道）

对于点对点的链路，目前使用得最广泛的数据链路层协议是点对点协议 PPP (Point-to-Point  Protocol)。

PPP协议的组成：

- 一个将IP数据封装到串行链路的方法
- 链路控制协议LCP
  - 每一个协议支持不同的网络层协议，如IP、OSI的网络层、AppleTalk等
- 网络控制协议NCP
  - 用来建立、配置和测试数据链路连接
  - 配合不同的网络层协议



##### PPP协议的帧格式

PPP 帧的首部和尾部分别为 4 个字段和 2 个字段

- 标志字段 F = 0x7E 
- 地址字段 A 只置为 0xFF 111111（如发现5个连续1则填充0）
-  控制字段 C 通常置为 0x03



#### CSMA/CD协议 （广播信道）

使用广播信道的数据链路层：

- 逻辑链路控制LLC （基本不考虑）
- 媒体接入控制MAC （接入到传输媒体有关内容）

网络接口板又称为通信适配器 (adapter) 或网络接口卡 NIC (Network Interface Card)，或“**网卡**”

以太网采取的两种重要的措施：

- 采用较为灵活的**无连接**的工作方式
  - 不先建立连接就可以直接发送数据
  - 有错误直接丢弃 差错处理由上层完成
- 以太网发送的数据都使用曼切斯特编码



 CSMA/CD含义：**载波监听多点接入 / 碰撞检测**

- 多点接入：许多计算机以多点接入的方式连接在一根总线上
- 载波监听：每一个站在发送数据之前要先检测一下总线上是否有其他计算机在发送数据。如果有则暂时不发送数据。
- 碰撞检测：计算机边发送数据边检测信道上的信号电压大小

![image-20230419211054758](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230419211054758.png)

显然，在使用CSMA/CD协议时，一个站不可能同时进行发送和接收（但必须边发送边监听信道）。因此使用CSMA/CD协议的以太网**不可能进行全双工通信而只能进行半双工通信**。

以太网的端到端往返时延 2τ称为争用期，或碰撞窗口。

##### 二进制指数类型退避算法

![image-20230419211736445](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230419211736445.png)

10 Mbit/s 以太网取 51.2 μs 为争用期的长度。 
 对于 10 Mbit/s 以太网，在争用期内可发送 512  bit，即 64 字节

这意味着： 以太网在发送数据时，**若前 64 字节没有发生冲突，则后续的数据就不会发生冲突**

最短有效帧长：

- 如果发生冲突，就一定是在发送的前 64 字节之内。
- 由于一检测到冲突就立即中止发送，这时已经发送出去的数据一定小于 64 字节。
- 以太网规定了最短有效帧长为 64 字节，凡长度小于 64 字节的帧都是由于冲突而异常中止的无效帧

![image-20230419212236511](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230419212236511.png)



##### 使用集线器的星型拓扑

粗同轴电缆->细同轴电缆->双绞线

采用双绞线的以太网采用星形拓扑，在星形的 中心则增加了一种可靠性非常高的设备，叫做集线器 (hub)。

![image-20230419213036006](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230419213036006.png)

![image-20230419213120322](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230419213120322.png)

集线器的特点：

- 使用集线器的以太网在逻辑上仍是一个总线网， 各工作站使用的还是 CSMA/CD 协议，并共享逻辑上的总线
- 同一时刻至多只允许一个站发送数据
- 集线器很像一个多接口的转发器，工作在**物理层**



##### 以太网的信道利用率

定义参数a，它是以太网单程端到端时延τ与帧发送时间T之比：
$$
a=\frac τ T_0 \\
$$
假定理想化情况，信道上不发生碰撞，则极限利用率为：
$$
S_{max}=\frac {T_0} {T_0+τ}=\frac 1 {1+a}
$$

- 只有当参数 a 远小于 1 才能得到尽可能高的极限信道利用率。 

- 据统计，当以太网的利用率达到 30% 时就已经处于重载的情况。很多的网 络容量被网上的碰撞消耗掉了.

##### 以太网的MAC层

在局域网中，硬件地址又称为物理地址或MAC地址

- IEEE 的注册管理机构 RA 负责向厂家分配地址字段 6  个字节中的前三个字节 (即高位 24 位)，称为组织唯一标识符

- 地址字段 6 个字节中的后三个字节 (即低位 24 位) 由厂家自行指派，称为扩展唯一标识符，必须保证生产出的适配器没有重复地址

![image-20230419214315427](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230419214315427.png)

适配器检查MAC地址：

- 如果是发往本站的帧则收下，然后再进行其他的处 理。 
-  否则就将此帧丢弃，不再进行其他的处理

“发往本站的帧”包括以下三种帧：

- 单播帧 一对一
- 广播帧 一对全体
- 多播帧 一对多

以混杂方式 (promiscuous mode) 工作的以太网适配器只要“听到”有帧在以太网上传输就 都接收下来。

![image-20230419214554880](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230419214554880.png)

无效的MAC帧：

- 帧长度不是整数个字节
- 用收到的帧检验序列FCS查出有差错
- 收到的帧的MAC客户数据字段的长度不在46\~1500字节之间。考虑MAC帧首部尾部长度共有18字节。有效MAC帧长度为64~1518字节之间。



#### 扩展的以太网

- 在物理层扩展以太网
  - 使用光纤、集线器扩展
- 在数据链路层扩展
  - 使用网桥、交换机扩展



交换机实际上就是一个多接口的网桥。

交换机的特点：

- 以太网交换机的**接口有存储器**，能在输出端口繁忙时把到来的帧进行缓存
- 以太网交换机是一种即插即用设备，其内部的**帧交换表（又称为地址表）是通过自学习算法自动地逐渐建立起来的**
- 以太网交换机使用了专用的交换结构芯片 (ASIC)，用硬件转发，其转发速率要比使用软件转发的网桥快很多

![image-20230419215136315](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230419215136315.png)

![image-20230419215154274](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230419215154274.png)

**注意泛洪的概念**



##### 生产树协议

![image-20230419215500970](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230419215500970.png)

生成树协议STP：

不改变网络的实际拓扑，但在**逻辑上则切断某些链路**，使得从一台主机到所有其他主机的**路径是无环路的树状结构**，从而消除了兜圈子现象。



#### 虚拟局域网

蠕虫病毒相当泛滥，一旦病毒发起泛洪广播攻击， 将会很快占用完网络的带宽，导致网络的阻塞和瘫痪。

虚拟局域网（ VLAN ）：它是将局域网从逻辑上**划分为一个个的网段**，从而实现虚拟工作组的一种交换技术

![image-20230419215647156](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230419215647156.png)



#### 高速比特网

**速率达到或超过 100 Mbit/s 的**以太网称为高速以太网。



##### 吉比特以太网

允许在 1 Gbit/s 下全双工和半双工两种方式工 作

在半双工方式下使用 CSMA/CD 协议，全双工方式不使用 CSMA/CD 协议



## 网络层

### 两种服务

在计算机网络领域，网络层应该向运输层提供怎样的服务？

- 面向连接  ——>  建立一条虚电路（逻辑上的一条路）
- 无连接  ——>  互联网

网络层向上只提供简单灵活、无连接的、尽最大努力交付的**数据报服务**，**网络层不提供服务质量的承诺**，由网络主机的运输层负责可靠交付（包括差错处理、流量控制等）



### 网络协议IP

网络协议IP是TCP/IP体系中两个最主要的协议之一

与IP协议配套使用的还有三个协议：

- 地址解析协议 ARP  （Address Resolution Protocol）
- 网际控制报文协议 ICMP (Internet Control Message Protocol)
- 网际组管理协议 IGMP (Internet Group Management Protocol)

![image-20230519195734487](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230519195734487.png)

如何将异构的网络互相连接起来？使用中继系统

不同层的中继系统：

- 物理层中继系统：转发器
- 数据链路层中继系统：网桥or桥接器
- 网络层中继系统：路由器
- 网络层以上的中继系统：网关
- 网桥和路由器的混合物  ——>  桥路器

虚拟互联网络的意义：互联起来的各种物理网络的异构性本来是客观存在的，但是我**们利用IP协议就可以使这些性能各异的网络从用户看起来好像是一个统一的网络**。



#### IP地址及其表示方法

IP地址就是给每个连接在互联网上的主机分配一个全世界范围内**唯一**的32位的标识符

IP地址的三种编址方式：

- 分类的IP地址
- 子网的划分
- 构成超网



##### 分类IP地址

将IP地址划分成若干类，每一类地址都由两个固定长度的字段组成。其中一个字段是网络号net-id，另一个字段是主机号host-id

![image-20230519201531213](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230519201531213.png)

三类地址可用范围：

- A：**1**.0.0.1 ~ **126**.255.255.254 （全0本网络、127广播地址）
- B：**128.0**.0.1 ~ **191.255**.255.254
- C：**192.0.0**.1 ~ **223.255.255**.254
- 三个分界线：128、192、223

数量：

- A：网络数：2^7^-2（7：8-1，-2：全0与127）主机数：2^24^-2（-2：全0与全1）
- B：网络数：2^14^ 主机数：2^16^-2
- C：网络数：2^21^ 主机数：2^8^-2

点分十进制：
![image-20230519201611006](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230519201611006.png)

一般不使用的特殊的IP地址：

| 网络号 | 主机号             | 源地址使用 | 目的地址使用 | 代表的意思                               |
| ------ | ------------------ | ---------- | ------------ | ---------------------------------------- |
| 0      | 0                  | 可以       | 不可         | 在本网络上的本主机（DHCP协议）           |
| 0      | host-id            | 可以       | 不可         | 在本网络上的某台主机host-id              |
| 全1    | 全1                | 不可       | 可以         | 只在本网络上进行广播（各路由器均不转发） |
| net-id | 全1                | 不可       | 可以         | 对net-id上的所有主机进行广播             |
| 127    | 非全0或全1的任何数 | 可以       | 可以         | 用作本地软件环回测试                     |

网络地址和主机地址：填写网络号/主机号，其余地方填0

IP地址的重要特点：

- IP地址是一种分等级的地址结构
- 实际上IP地址是标志一个主机（或路由器）和一条链路的接口
  - 一个主机同时连接到两个网络时，主机就必须同时具有两个相应的IP地址，网络号必须是不同的，所以一个路由器至少应当有两个不同的IP地址
- 用**转发器或网桥**连接起来的若干个局域网仍为一个网络，具有同样的网络号net-id
- 所有分配到网络号net-id的网络，无论范围大小，地位都是平等的



#### IP地址与硬件地址

IP地址与硬件地址是不同的地址

从层次的角度：硬件地址是数据链路层与物理层使用的地址，IP地址是网络层和以上各层使用的地址，是**一种逻辑地址**

以太网帧的目的地址和IP包头的目的地址分别为MAC地址和IP地址，两者互不冲突



#### 地址解析协议  ARP

通信时使用的两个地址：

- IP地址（网络层地址）
- MAC地址（数据链路层地址）

**ARP作用：从网络层使用的IP地址，解析出在数据链路层使用的硬件地址**

![image-20230519211508494](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230519211508494.png)

当主机A欲向本局域网的某个主机B发送IP数据报时，就先在其ARP高速缓存中查看有无B的IP地址：

- 如果有，就可以查出对应的硬件地址，再将此硬件地址写入MAC帧，然后通过局域网将该MAC帧发往此硬件地址
- 如没有，ARP进程在本局域网上广播发送一个**ARP请求分组**（顺带把自己的地址也写入其中）。收到**ARP响应分组**后，将得到的IP地址到硬件地址的映射写入ARP高速缓存。

当目的主机和源主机**不在同一个局域网**时，通过ARP找到默认网关的硬件地址，然后由默认 网关把分组转发给下一个网络

每一个主机都设有一个**ARP高速缓存**，用于存放最近获得的 IP 地址到 MAC 地址的绑定





#### IP数据报格式

一个IP数据报由**首部**和**数据**两部分组成

- 首部前一部分是固定长度，共20字节，是所有IP数据报所必须具有的
- 在首部的固定部分后面是一些可选字段，其长度是可变的

![image-20230519213311618](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230519213311618.png)

IP数据报的首部通常包含**20字节（160位）的固定长度**，**由于每个字节有8位**，所以可以表示为32位为一行，一行4个字节

- 总长度：占16位，指首部与数据之和的长度，单位为字节，故最大长度为65545字节。**总长度必须不超过最大传送单元MTU**
- 标志：只有前两位有意义 最低位**MF=1表示后面还有分片  MF=0表示最后一个分片** 中间一位**DF=0时才允许分片**
- 片位移：占13位，较长的分组在分片后某片在原分组中的相对位置，以8个字节为偏移单位。
  - **计算方式：之前的数据报片长度之和(无首部)/8**
- 首部检验和：占16 位，**只检验数据报的首部， 不检验数据部分**。这里不采用 CRC 检验码而采用简单的计算方法。（16 位二进制反码求和算法）



#### IP转发分组的流程

如果按照**主机号**来制作路由表，会导致整个路由表过于庞大。但是如果按照主机所在的**网络地址**来制作路由表，就可以使得路由表大大简化。这样做的结果是：

- IP 数据报最终一定可以找到目的主机所在目的网络上的路由器（可能要通过多次的间接交付）。
- 只有到达最后一个路由器时，才试图向目的主机进行直接交付。

特殊的路由形式：

- 特定主机路由
- 默认路由：只要目的网络不是N~1~或者N~2~，则一律选择默认路由（在小网络连接互联网时特别合适）

**路由器转发分组算法：**

1. 从数据报的首部提取**目的主机的 IP 地址 D**, 得出**目的网络地址为N**
2. 若网络 N 与此路由器**直接相连**，则把数据报**直接交付**目的主机D；否则是**间接交付**，执行(3)
3. 若路由表中有目的地址为 D 的**特定主机路由**，则把数据报传送给路由表中所指明的下一跳路由器；否则，执行(4)
4. 若路由表中有**到达网络 N 的路由**，则把数据报传送给路由表指明的下一跳路由器；否则，执行(5)
5. 若路由表中有一个**默认路由**，则把数据报传送给路由表中所指明的默认路由器；否则，执行(6)
6. 报告转发分组出错



#### 划分子网和构造超网

从 1985 年起在 IP 地址中又增加了一个“子网号字段”，使得二级IP地址到三级IP地址，这种做法叫做**划分子网**。

划分子网纯属一个**单位内部的事情**。单位对外仍然表现为没有划分子网的网络。从主机号**借用**若干个位作为子网号 subnet-id，而主机号 host-id 也就相应减少了若干个位。

![image-20230520204400960](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230520204400960.png)

主要流程：

- 凡是从**其他网络**发送给本单位某个主机的 IP 数据报，仍然是根据 IP 数据报的**目的网络号 net-id**，先找到连接在本单位网络上的路由器
- 然后**此路由器**在收到 IP 数据报后，再按**目的网络号** net-id 和**子网号** subnet-id 找到目的子网
- 最后就将 IP 数据报直接交付目的主机

优点：

- 减少了 IP 地址的浪费
- 使网络的组织更加灵活 
- 更便于维护和管理



##### 子网掩码

从一个 IP 数据报的首部并无法判断源主机或目的主机所连接的网络是否进行了子网划分，而使用**子网掩码**可以找出IP地址中子网的部分。

规则：

- 子网掩码长度：32位
- **某位=1**：IP地址中对应位为**网络号和子网号**
- **某位=0**：IP地址中的对应位为**主机号**

![image-20230520205934651](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230520205934651.png)

**(IP地址) AND (子网掩码) = 网络地址** (均为1时才为1)

子网掩码的表示：

- 使用十进制数表示：255.255.255.0
- 使用“/网络位数”表示，如13.129.6.1/8 -> 13.129.6.1 255.0.0.0

(PPT 141页计算题)



##### **使用子网时分组的转发**

但在划分子网的情况下，从 IP 地址却不能唯一地得出网络地址来，这是因为网络地址取决于 那个网络所采用的子网掩码，但数据报的首部并没有提供子网掩码的信息，因此分组转发的算法也必须做相应的改动。

在**划分子网情况下**路由器转发分组的算法：

1. 从收到的分组的首部提取目的 IP 地址 D
2. (发送端)先用各网络的**子网掩码和 D 逐位相“与”**(AND)，看是否和相应的网络地址匹配。若匹配，则将分组直接交付。否则就是间接交付，执行(3)
3. 若路由表中有目的地址为 D 的**特定主机路由**，则将分组传送给指明的下一跳路由器；否则，执行 (4)。
4. **对路由表中的每一行，将子网掩码和 D 逐位相“与”**(AND)(直接由2.结果可得)。若结果与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器；否则，执行(5)
5. 若路由表中有一个**默认路由**，则将分组传送给路由表中所指明的默认路由器；否则，执行 (6)
6. 报告转发分组出错

**用路由表条目中各网络的子网掩码和目的 IP 地址逐位相“与”**，判断是否和相应的网络地址匹配。



#### 无分类编址 CIDR

特点：

- **CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念**，因而可以更加有效地分配 IPv4 的地址空间
- 使用各种长度的“网络前缀”(network-prefix)来代替分类地址中的网络号和子网号
- IP 地址从三级编址（使用子网掩码）又回到了两级编址

![image-20230520220329586](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230520220329586.png)

CIDR 把网络前缀都相同的连续的 IP 地址组成“CIDR 地址块“

128.14.32.0/20 表示的地址块共有 2^12^个地址（因为斜线后面的 **20 是网络前缀的位数**，所以这个地址的**主机号是 12 位**）

![image-20230520220517239](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230520220517239.png)



| CIDR前缀长度 | 点分十进制        | 包含的地址数 | 相当于包含分类的网络数 |
| ------------ | ----------------- | ------------ | ---------------------- |
| **/16**      | **255.255.0.0**   | **64K**      | **1个B类或256个C类**   |
| /20          | 255.255.240.0     | 4K           | 16个C类                |
| **/24**      | **255.255.255.0** | **256**      | **1个C类**             |



##### 路由聚合

一个 CIDR 地址块可以表示很多地址，这种地址的聚合常称为路由聚合，它使得路由表中的 一个项目可以表示很多个（例如上千个）原来传统分类地址的路由。

**路由聚合也称为构成超网 (supernetting)**

为确定聚合后的路由，路由器找出这些地址中最 左边的多少比特是**完全相同的**



#### 最长前缀匹配

使用 CIDR 时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。在查找路由表时可能会得到**不止一个匹配结果**。

应当从匹配结果中选择具有最长网络前缀的路由：**最长前缀匹配**

**举例：**

收到的分组的目的地址D=206.0.71.130

![image-20230520222134867](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230520222134867.png)

#### 使用二叉线索查找路由表

当路由表的项目数很大时，怎样设法减少路由表的查找时间就成为一个非常重要的问题

为了进行更加有效的查找，通常是将无分类编址的路由表存放在一种层次的数据结构中，然后**自上而下按层次进行查找**。

IP地址中从左到右的比特值决定了从根结点逐层向下层延伸的路径。

![image-20230522193649203](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230522193649203.png)



### 网络控制报文协议 ICMP

为了更有效地转发IP数据报和提高交付成功的机会，在网络层使用了网络控制报文协议ICMP（Internet Control Message Protocol）

- ICMP是互联网的标准协议
- **ICMP用于主机或路由器报告差错情况和提供有关异常情况的报告**
- **ICMP不是高层协议**，ICMP的报文封装在IP数据报中，作为其中的数据部分，所以它是IP层的协议

ICMP报文的格式：

![image-20230522194723582](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230522194723582.png)

ICMP报文的种类有两种：

- ICMP**差错报告报文**
- ICMP**询问报文**



ICMP的应用：

- PING（Packet InterNet Groper）
  - **PING用来测试两个主机之间的连通性**
  - PING是**应用层直接使用网络层**ICMP的例子，它没有通过运输层的TCP或UDP
- Traceroute（tracert）
  - **tracert用来跟踪一个分组从源头到终点的路径**
  - 它利用IP数据报中的TTL字段和ICMP时间超过差错报告报文实现对从源点到终点的路径的跟踪



### 路由选择协议

从路由算法的自适应性考虑：

- 静态路由选择策略——即非自适应路由选择，特点是简单且开销小，但不能及时适应网络状态的变化
- 动态路由选择策略——即自适应路由选择，其特点是能较好地适应网络状态的变化，但实现起来较为复杂，开销也较大



互联网采用分层次的路由选择协议，这是因为：

- 互联网的规模非常大，如果让所有路由器都知道所有网络应该如何抵达，则会使得路由表非常之大
- 许多单位不愿意外界了解自己单位网络的布局细节和本部门所才用的路由选择协议



##### 自治系统 Autonomous System

定义：在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议用以确定分组在 AS之间的路由。

尽管**一个 AS 使用了多种内部路由选择协议和度量**，但重要的是一个 AS 对其他 AS 表现出的是一个**单一的和一致的路由选择策略**



互联网两大类路由选择协议：

- 内部网关协议 IGP （Interior Gateway Protocol）
  - 在一个自治系统**内部使用**的路由选择协议
  - 使用量最多，例如RIP和OSPF
- 外部网关协议 EGP （External Gateway Protocol）
  - 在自治系统边界时，将路由选择信息传递到另一个自治系统中
  - 使用最多的是BGP-4协议

![image-20230522201517741](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230522201517741.png)

自治系统之间的路由选择也叫作**域间路由选择**(interdomain routing)，在自治系统内部的路由选择叫作**域内路由选择**(intradomain routing)。



#### 路由信息协议 RIP

路由信息协议 RIP (Routing Information  Protocol) 是内部网关协议 IGP 中最先得到广泛使用的协议

- RIP 是一种**分布式的、基于距离向量的路由选择协议**
- RIP 协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录

“距离“的定义：

- 从一个路由器到**直接连接**的网络的距离定义为1
- 从一个路由器到非直接连接的网络的距离定义为所经过的路由器数**加 1**
- RIP协议中的距离也被称为”跳数“
- **RIP 允许一条路径最多只能包含 15 个路由**
- **“距离”的最大值为 16 时即相当于不可达**
- **RIP 不能在两个网络之间同时使用多条路由**，RIP选择一个具有最少路由器的路由，哪怕还存在另一个高速（低时延）但路由器较多的路由



**RIP协议的三个特点：**

- 仅和**相邻路由器**交换信息
- 交换的信息时当前本路由器知道的**全部信息，即自己的路由表**
- 按**固定的时间间隔**交换路由信息。即使网络拓扑发生变化时，路由器也能及时向相邻路由器通告拓扑变化后的路由信息
- **好消息传播得快，坏消息传播得慢**
- RIP能使用的最大距离为 15跳，适用于小型网络



RIP存在的一个问题：当网络出现故障时，要经过比较长的时间 (例如数分钟) 才能将此信息传送到所有的路由器



**距离向量算法：**

1. 路由器收到相邻路由器（**其地址为X**）的一个RIP报文

2. 先修改此RIP报文中的所有项目：把”**下一跳“字段中的地址都改为X**，并把所有**”距离“字段的值都加1**

3. 若**目的网络不在路由表**中，则把该项目加到路由表中

   - 否则

     若**下一跳**字段给出的路由地址是**相同的**（例如路由表中也为X），则把收到的项目替换原路由表中的项目（**直接修改**）

   - 否则

     若收到**项目的距离小于路由表中的距离**（下一跳不相同），则进行更新（下一跳地址也会更新）

   - 否则

     什么也不做

4. ) 若 3 分钟还没有收到相邻路由器的更新路由表，则把此相邻路由器记为不可达路由器，即将距离置为 16（表示不可达）

5. 返回

![image-20230623222029215](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230623222029215.png)

**RIP2报文具有简单的鉴别功能**



#### 开放最短路径优先 OSPF

开放最短路径优先 OSPF (Open Shortest Path First)是为克服 RIP 的缺点在1989年开发出来的

OSPF协议基本特点：

- ”开放“表明OSPF协议不是受某一家厂商控制，而是公开发表的
- ”最短路径优先“是因为使用了Dijkstra提出的最短路径算法 
- 采用分布式的链路状态协议 (link state protocol)
- OSPF 通过**洪泛**发送更新分组
- **OSPF 不用 UDP 而是直接用 IP 数据报传送**
- **OSPF 的更新过程收敛得快是其重要优点**
- OSPF 对不同的链路可根据 IP 分组的不同服务类型 TOS 而设置成不同的代价。因此，**OSPF 对于不同类型的业务可计算出不同的路由路径**
- 如果到同一个目的网络有多条相同代价的路径，那么可以将通信量分配给这几条路径。这叫作**多路径间的负载平衡**
- **支持可变长度的子网划分和无分类编址 CIDR**
- 所有在 OSPF 路由器之间交换的分组都具有**鉴别**的功能
- 每一个链路状态都带上一个 32 位的序号，序号越大状态就越新
- **OSPF 没有“坏消息传播得慢”的问题**，因为一个路由器的链路状态只涉及到与相邻路由器的连通状态，与整个互联网的规模并无直接关系。因此当**互联网规模很大时，OSPF  协议要比距离向量协议 RIP 好得多**



注意：OSPF 只是一个协议的名字，它并不表示其他的路由选择协议**不是**“最短路径优先”

三个表：

- 邻居表
  - 邻居路由器得信息
- 拓扑表 (**链路状态数据库 LSDB**)
  - “链路状态”就是说明本路由器都和哪些路由器相邻，以及该链路的“度量”(metric)
  - 这个数据库实际上就是**全网的拓扑结构图**，同区域中所有路由器的LSDB信息必须保持一致
  - OSPF 的链路状态数据库能**较快地进行更新**，使各个路由器能及时更新其路由表
  - **OSPF 的更新过程收敛得快是其重要优点**
- 路由表
  - 到达目标网络的最佳路径

<img src="C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230522231842664.png" alt="image-20230522231842664" style="zoom: 50%;" />

OSPF采用**最短路径优先（SPF）**算法来进行最佳路由的计算：SPF算法将路由器作为树根，根据累计成本计算到每个节点的最短路径，默认情况下使用100Mbps/带宽来计算OSPF成本

为了使 OSPF 能够用于规模很大的网络， OSPF 将一个自治系统再划分为若干个更小的范围，叫作**区域**

每一个区域都有一个 32 位的区域标识符（用点分十进制表示）

![image-20230522232128852](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230522232128852.png)

划分区域：

- 好处就是将利用洪泛法交换链路状态信息的范围局限于每一个区域而不是整个的自治系统，这就减少了整个网络上的通信量
- 在一个区域内部的路由器**只知道本区域的完整网络拓扑**，而不知道其他区域的网络拓扑的情况
- OSPF 使用层次结构的区域划分。在上层的区域叫作主干区域 (backbone area)
- 主干区域的标识符规定为0.0.0.0，主干区域的作用是用来连通其他在下层的区域



指定的路由器：

- 多点接入的局域网采用了指定的路由器 (designated router) 的方法，使广播的信息量 大大减少
- 指定的路由器**代表**该局域网上所有的链路向连接到该网络上的各路由器发送状态信息



#### 外部网关协议 BGP

BGP是不同自治系统的路由器之间交换路由信息的协议

由于互联网规模太大，使得自治系统之间寻找最佳路径是很不现实的

**比较合理的做法是在AS之间交换”可达性“信息**

BGP发言人：

- 每一个自治系统要选择至少一个路由器作为该自治系统的”BGP发言人“
- 一个 BGP 发言人与其他自治系统中的 BGP 发言人要交换路由信息，就要先建立 TCP 连接
- BGP 支持 CIDR，因此 BGP 的路由表也就应当包括目的网络前缀、下一跳路由器，以及到达该目的网络所要经过的各个自治系统序列



### IPv6

IPv4地址已经耗尽，解决方案是采用具有更大地址空间的新版本IP

IPv6数据报由两大部分组成：

- 基本首部
- 有效载荷：有效载荷允许有0个或多个扩展首部，再后面是数据部分

![image-20230524204340708](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230524204340708.png)

基本首部：

- IPv6将首部长度变为**固定40字节**，称为基本首部
- 将首部中不必要的功能取消了，使得**字段数减少到只有8个**

扩展首部：

- IPv6把IPv4首部中选项的功能都放在扩展首部中，并将扩展首部留给路径两端的源站和目的站的主机来处理
- 数据报途中经过的路由器都不处理扩展首部（**只有一个首部例外，即逐跳选项扩展首部**）
- 此举大大提高了路由器的处理效率



在IPv6中，每个地址占 128 位，为了使地址简洁，IPv6 使用冒号十六进制记法

每个 16 位的值用十六进制值表示，各值之间用冒号分隔。例如：

68E6:8C64:FFFF:FFFF:0:1180:960A:FFFF

在十六进制记法中，允许把数字前面的0省略。例如把 0000中的前三个0省略，写成1个0

零压缩：

冒号十六进制记法可以允许零压缩，即一连串连续的零可以为一对冒号所取代，例如：

FF05:0:0:0:0:0:0:B3 => FF05::B3

**在任一地址中只能使用一次零压缩**



##### 特殊地址

- 未指明地址：16字节全0地址，可缩写为两个冒号 ::
- 环回地址： 0:0:0:0:0:0:0:1 (::1)



##### IPv4向IPv6过渡

两种过渡策略：

- 双协议栈
  - 使用一部分主机（路由器）装有两个协议栈
  - 双协议栈主机记为IPv4/IPv6 表明它同时具有两种IP地址
- 隧道技术
  - 在IPv6数据报要进入IPv4网络时，**把IPv6数据报封装成IPv4数据报**，整个IPv6数据报变成了IPv4数据报的数据部分
  - 当 IPv4 数据报离开 IPv4 网络中的隧道时，再把数据部分（即原来的 IPv6 数据报）交给主机的 IPv6 协议栈



### IP多播

- 在互联网上进行多播就叫作 IP 多播
- 多播地址只能用于目的地址，不能用于源地址
- 多播组的标识符就是 IP 地址中的 D 类地址
- 对多播数据报不产生 ICMP 差错报文。因此， 若在 PING 命令后面键入多播地址，将永远不会收到响应



### 网络组管理协议 IGMP

为了使路由器知道多播组成员的信息，需要利用网际组管理协议 IGMP(Internet Group Management Protocol)

连接在局域网上的多播路由器还必须和互联网上的其他多播路由器协同工作，以便把多播数据报用最小代价传送给所有的组成员。这就需要使用**多播路由选择协议**

IGMP 协议是**让连接在本地局域网上的多播路由器知道本局域网上是否有主机**（严格讲，是主机上的某个进程）参加或退出了某个多播组



### 虚拟专用网 VPN

IP地址不够用，自行分配的本地地址可能与全球唯一地址产生冲突

指明部分专用地址，在互联网中的所有路由器对专用地址一律不转发

- 10.0.0.0 到 10.255.255.255  A类
- 172.16.0.0 到 172.31.255.255  B类
-  192.168.0.0 到 192.168.255.255  C类



利用公用的互联网作为本机构各专用网之间的通信载体，这样的专用网又称为虚拟专用网 VPN (Virtual Private Network)

**所有通过互联网传送的数据都必须加密**

远程接入 VPN (remote access VPN)可以满足外部流动员工访问公司网络的需求。

![image-20230524211709570](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230524211709570.png)



### 网络地址转换 NAT

需要在专用网连接到互联网的路由器上安装NAT 软件。装有NAT软件的路由器叫作NAT路由器，它至少有一个有效的外部全球IP地址

所有使用本地地址的主机在和外界通信时，**都要在 NAT 路由器上将其本地地址转换成全球 IP 地址**，才能和互联网连接

![image-20230524211856080](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230524211856080.png)

为了更加有效地利用 NAT 路由器上的全球IP地址， 现在常用的 NAT 转换表把运输层的**端口号**也利用上。这样，就可以使多个拥有本地地址的主机，共用一个 NAT 路由器上的全球 IP 地址，**因而可以同时和互联网上的不同主机进行通信**

使用**端口号的 NAT 叫作网络地址与端口号转换 NAPT** (Network Address and Port Translation)， 而不使用端口号的 NAT 就叫作传统的 NAT  (traditional NAT)



## 运输层

### 概述

从通信和信息处理的角度来看，运输层向应用层提供通信服务，它属于面向通信部分的最高层，同时也是用户功能中的最底层。



只有位于**网络边缘部分**的主机的协议栈才有运输层，而**网络核心部分**中的路由器在转发分组时都**只用到下三层的功能**

![image-20230603195206858](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230603195206858.png)

从**运输层**的角度看，通信的真正端点并不是主机而是主机中的进程。也就是说，**端到端的通信是应用进程之间的通信**。

- 网络层是为主机之间提供逻辑通信
- 运输层是为应用进程之间提供端到端的逻辑通信，一个主机可能有多个应用进程同时分别和另一个主机中的多个应用进程通信



由于运输层可能存在多个应用进程同时通讯，所以运输层有一个很重要的功能——**复用和分用**

![image-20230603195948711](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230603195948711.png)



#### 两个主要协议

TCP/IP 的运输层有两个主要协议：

- 用户数据报协议 UDP (User Datagram Protocol)
- 传输控制协议 TCP (Transmission Control Protocol)



**UDP：一种无连接协议**

- 提供无连接服务，不提供可靠交付
- 在传送数据之前不需要先建立连接
- 传送的数据单位协议是 **UDP 报文或**用户数据报
- 对方的运输层在收到 UDP 报文后，不需要给出任何确认



**TCP：一种面向连接的协议**

- 提供可靠的、面向连接的服务
- 传送的数据单位协议是 **TCP 报文段** (segment)
- **TCP 不提供广播或多播服务**
- 开销大、占用的处理器资源多



#### 运输层的端口

- 端口用一个 16 位端口号进行标志
- 端口号只具有**本地意义**，只是为了**标志本计算机应用层中的各进程**



两大类端口：

- 服务器端使用的端口号
  - 数值端口：0~1023
  - 登记端口号：1024~49151
- 客户端使用的端口号
  - 短暂端口号：49152~65535，留给客户进程选择暂时使用
- 熟记端口
  - 53 DNS
  - 21、20 FTP
  - 80 HTTP
  - 443 HTTPS

运输层**利用端口**标志本计算机应用层中的各进程，**实现复用和分用功能**



### 用户数据报协议 UDP

#### 概述

UDP只在IP数据包服务之上增加了很少一点功能：

- 复用和分用的功能
- 差错检测的功能（但没提供可靠数据传输）

**主要特点：**

- **UDP是无连接的**
  - 发送数据之间不需要建立连接，因此减少了开销和发送数据之前的时延
- **UDP使用尽最大努力交付**
  - 即不保证可靠交付，因此主机不需要维持复杂的连接状态表
- **UDP是面向报文的**
  - UDP对应用层交下来的报文，**既不合并也不拆分**，而是保留这些报文的边界，**UDP一次交付一个完整的报文**
- **UDP没有拥塞控制**
  - 网络出现的拥塞不会使源主机的发送速率降低

 UDP 支持一对一、一对多、多对一和多对多的交互通信，而且UDP首部开销小

![image-20230603202926554](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230603202926554.png)

**UDP的应用：**

- 对运输协议的可靠性要求不高，需要传输的数据不多，使用频率不高
  - **DNS服务、DHCP服务、SNMP服务**
- 实时应用
  - IP电话、视频会议、直播



#### UDP的首部格式

用户数据报UDP有两个字段：首部字段和数据字段。**首部字段只有8字节**

![image-20230603203556547](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230603203556547.png)

在计算检验和时，临时把“伪首部”和 UDP 用户数据报连接在一起。伪首部仅仅是为了计算检验和。（**联立求和，之后反码得出校验和**）

- **长度为用户数据报总长度**
- **检验和字段：**
  - 校验和算法一样，但作用范围不同
  - IP校验和只校验**IP数据报的首部**
  - ICMP校验和覆盖整个**ICMP报文（首部+数据）**
  - UDP和TCP校验和不仅**覆盖整个报文**，而且还有12字节的**伪首部**






### 传输控制协议 TCP

主要特点：

- TCP是**面向连接的**运输层协议
- 每条TCP只能有两个端点，每一条TCP连接只能是**一对一的**
- TCP提供**可靠交付**的服务
- TCP提供**全双工**通信
- **面向字节流**（为后面窗口和网络拥塞调整做铺垫）
  - TCP 中的“流”(stream)指的是流入或流出进程的字节序列
  - “面向字节流”的含义是：虽然应用程序和 TCP 的交互是一次一个数据块，但 TCP 把应用程序交下来的数据看成仅仅是一连串无结构的字节流
  - TCP **不保证**接收方应用程序所收到的数据块和发送方应用程序所发出的数据块具有对应大小的关系
  - 接收方应用程序收到的字节流必须和发送方应用程序发出的字节流完全一样

TCP 根据**对方给出的窗口值和当前网络拥塞的程度**来决定一个报文段应**包含多少个字节**



#### TCP的连接

每一条TCP连接有两个端点，TCP连接的端点叫做套接字(socket)或插口

- **端口号**拼接到**IP 地址**即构成了套接字：`套接字socket=(IP地址:端口号)`

- 每一条 TCP 连接唯一地被通信两端的两个端点：`TCP连接::={socket1,socket2}`



### 可靠传输的工作原理

理想的传输条件有以下两个特点：

- 传输信道不产生差错
- 不管发送方以多块的速度发送数据，接收方总是来得及处理收到的数据

然而实际网络都不具备以上两个理想条件，所以必须使用一些可靠传输协议



#### 停止等待协议

“停止等待”就是**每发送完一个分组就停止发送**，等待对方的确认。在收到确认后再发送下一个分组

##### 无差错情况（正常情况）

A 发送分组 M1，发完就暂停发送，等待 B 的**确认 (ACK)**。B 收到了 M1 向 A 发送 ACK。A 在收到了对 M1 的确认后，就再发送下一个分组 M2

<img src="C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230603215750465.png" alt="image-20230603215750465" style="zoom:67%;" />

##### 出现差错

在接收方 B 会出现两种情况：

- B在接收M1时检测出了差错，就直接丢弃M1，其他什么也不做
- M1在传输过程中丢失了，B什么都不知道，也什么都不做

两种情况B都不会发送任何信息，如何保证B正确收到了M1？

**解决方法：超时重传**

- A为每一个已发送的分组都设置了一个**超时计时器**
- A只要在超时计时器到期之前收到相应确认，就撤销该超时计时器，继续发送下一个分组M2

![image-20230603220212385](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230603220212385.png)



##### 确认(ACK)丢失

若B所发送的对M1的确认丢失了，A设置的超时计时器就会到期，**因此A在到期后会重传M1**

B又重新收到M1，则会：

- **丢弃**这个重复的M1，不向上层交付
- **向A再次发送确认**



##### 确认(ACK)迟到

传输过程中没有差错，但B对M1的确认迟到了

处理方式：

- B仍然会收到重复的M1，并且同样要丢弃重复的M1，并重传确认分组
- A会收到重复的确认，收下后直接丢弃

![image-20230603220858859](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230603220858859.png)

**由此可见：**

- 分组和确认分组都必须进行编号
- 在发送完一个分组后，必须暂时保留已发送的分组的副本，以备重发



##### 自动重传请求ARQ

通常 A 最终总是可以收到对所有发出的分组的确认。使用上述的确认和重传机制，我们就可以在不可靠的传输网络上实现可靠的通信。

像这种可靠传输协议常称为自动重传请求 ARQ (Automatic Repeat reQuest)。

意思是**重传的请求是自动进行的**，接收方不需要**请求**发送方重传某个出错的分组



#### 信道利用率

![image-20230606234031838](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230606234031838.png)

停止等待协议的**优点是简单**，缺点是**信道利用率太低。**

为提高传输效率，发送方可以使用**流水线传输**

**信道利用率还可以使用`最大吞吐量/信道带宽`进行计算**



流水线传输就是发送方可连续发送多个分组，不必每发完一个分组就停顿下来等待对方的确认。这样可使信道上一直有数据不间断地传送

![image-20230603221752634](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230603221752634.png)



##### 连续ARQ协议

发送方维持的发送窗口，它的意义在于：

- **位于发送窗口内的分组都可以连续发送出去，而不需要等待对方确认**

规定：

- **发送方每收到一个确认，就把发送窗口向前滑动一个分组的位置**

![image-20230606193519234](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230606193519234.png)

##### 累计确认

接收方一般采用**累积确认**的方式。即不必对收到的分组逐个发送确认，而是对按序到达的最后一个分组发送确认。这就表示：**到这个分组为止的所有分组都已正确收到了**

优点：容易实现，即使**确认丢失**也不必重传

缺点：不能向发送方反映出接收方已经正确收到的所有分组的信息



##### 回退N

如果发送方发送了前5个分组，而第3个分组丢失了。这时接收方只能对前两个分组发出确认。发送方不知道后面三个分组的下落，**只能把后三个分组都重新再传一次**



##### TCP可靠通讯的具体实现

- TCP连接的每一端都必须设有两个窗口——一个**发送窗口**和一个**接收窗口**
- TCP的可靠传输机制用**字节的序号**进行控制
- TCP所有的确认都是**基于序号而不是基于报文段**的
- TCP两端的四个窗口经常处于动态变化中
- TCP连接的往返时间RTT也不是固定不变的，需要有特定的算法估算较为合理的重传时间



##### 小结

- 流水线传输允许发送方**连续发送**多个分组，而**不需要等待对方的确认**，从而提高信道利用率
- 位于**发送窗口内**的分组可连续发送出去
- 发送方每收到一个确认，就把**发送窗口向前滑动**一个分组的位置
- 接收方采用**累积确认**的方式对按序到达的**最后一个分组发送确认**



### TCP报文段的首部格式

TCP 虽然是面向字节流的，**但 TCP 传送的数据单元却是报文段**

TCP 报文段首部的前 20 个字节是固定的，后面有 4n 字节是根据需要而增加的选项 (n 是整数)。**因此 TCP 首部的最小长度是 20 字节**。

![image-20230606200637235](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230606200637235.png)

解释：

- 源端口和目的端口——各占两字节，端口是运输层与应用层的服务接口，运输层的复用和分用功能都要靠端口才能实现
- 序号字段——占4字节。TCP连接中传送的数据流中的每一个字节都编上一个序号。**序号字段的值则指的是本报文段所发送的数据的第一个字节的序号**
- 确认号字段——占 4 字节，确认号字段的值**是期望收到对方的下一个报文段的数据的第一个字节的序号**
- 序号和确认号可以理解为两条传输序列，所以序号比确认号小是存在的，因为两者一个在A线，一个在B线
- 数据偏移（即**首部长度**）——占 4 位。它指出 TCP 报文段的数据起始处距离 TCP 报文段的起始处有多远。“数据偏移”的单位是 32 位字（**以 4 字节为计算单位**）
- 保留字段——占 6 位，保留为今后使用，但目前应置为 0
- 描述字段
  - 紧急URG，URG=1时，表明紧急指针字段有效，应尽快传输
  - 确认ACK，**只有当ACK=1时确认号字段才有效**
  - 推送PSH，接收 TCP 收到 PSH = 1 的报文段，就**尽快地交付**接收应用进程，而**不再等到整个缓存都填满了**后再 向上交付
  - 复位RST，当 RST=1 时，表明 TCP 连接中出现严重差错（如由于主机崩溃或其他原因），**必须释放连接，然后再重新建立运输连接**
  - 同步 SYN ，同步 SYN = 1 表示这是一个连接请求或连接接 受报文
  - 终止 FIN，用来释放一个连接。FIN=1 表明此报文段的**发送端的数据已发送完毕**，并要求**释放运输连接**
- 窗口字段 —— 占 2 字节，窗口字段用来控制**对方发送的数据量**， 单位为字节。**TCP 连接的一端根据设置的缓存空间大小确定自己的接收窗口大小**，然后通知对方以确定对方的发送窗口的上限
  - 窗口字段指出了现在**允许对方发送**的数据量
- 检验和——占 2 字节。检验和字段检验的范围包括**首部和数据这两部分**。在计算检验和时，要在 TCP 报文段的前面加上 12 字节的伪首部
- 紧急指针字段 —— 占 16 位，指出在本报文段中紧急数据共有多 少个字节（紧急数据放在本报文段**数据的最前面**）
- 选项字段——长度可变。TCP最初只规定了一种选项，即**最大报文段长度MSS**。MSS是“**TCP 报文段长度减去 TCP 首部长度**”。MSS告诉对方TCP：”我的缓存所能接收的报文段的数据字段的最大长度是MSS个字节“
  - MSS与接收窗口值没有关系
  - 若选择较小MSS长度，则网络利用率低
  - 若TCP报文段非常长，则在IP层传输的适合就会被分解成多个短数据报片，重点还需要把各个报片重新装配成TCP报文段，导致开销增大



#### 总结

- TCP的每条连接都有**发送序号**和**确认号**
- **序号字段**是**本报文段所发送的数据的第一个字节的序号**
- **确认号字段**是**期望收到对方的下一个报文段的数据的第一个字节的序号**(在这序号之前的数据已经接收)
- TCP连接的一端**根据缓存空间大小确定自己的窗口大小**，利用窗口字段**控制对方发送的数据量**



### TCP可靠传输的实现

**TCP的滑动窗口是以字节为单位的**

现假定 A 收到了 B 发来的确认报文段，其中**窗口是 20 字节**，而**确认号是 31**（**这表明 B 期望收到的下一个序号是 31**，而序号 30 为止的数据已经收到了）根据这两个数据，A 就构造出自己的发送窗口

![image-20230606212154817](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230606212154817.png)

接下来是一个发送的示例

**首先A发送了11字节的数据**

![image-20230608144944363](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608144944363.png)

**此时A收到新的确认号，窗口向前滑动**

![image-20230608145236362](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608145236362.png)

如果A的发送窗口内的序号都已**用完**，但是**没有收到确认**，则必须**停止发送**

![image-20230608151810930](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608151810930.png)

#### 发送缓存&&接收缓存

发送方的**应用进程**把字节流写入TCP的发送缓存。发送窗口通常只是发送缓存的一部分

而接收方的应用程序从TCP的接收缓存中读取字节流

#### 需要强调的三点

- A 的发送窗口并**不总是**和 B 的接收窗口一样大（因为有一定的时间滞后）
- TCP 标准**没有规定**对**不按序到达**的数据应如何处理。通常是先临时存放在接收窗口中，等到字节流中所缺少的字节收到后，再按序交付上层的应用进程
- TCP 要求接收方必须有累积确认的功能，这样可以减小传输开销

接收方可以在**合适的时候发送确认**，也可以在自己有数据要发送时把确认信息**顺便捎带上**

#### 小结

- TCP连接的一端根据**另一端给出的窗口值**构造**自己的发送窗口**
- TCP连接的一端可以**连续把发送窗口内的数据都发送出去**，而不需要等待对方确认
- 收到新的确认号，发送窗口**向前滑动**



##### 超时重传的选择

重传时间的选择是 TCP 最复杂的问题之一：

- 如果把超时重传时间设置得**太短**，就会引起很多报文段的**不必要的重传**，使**网络负荷增大**
- 但若把超时重传时间设置得**过长**，则又使网络的**空闲时间增大**，**降低了传输效率**

TCP采用一套**自适应算法**来计算报文段的往返时间 RTT

超时重传时间 RTO**略大于**往返时间 RTT



### TCP流量控制

我们希望数据传输更快一点，但是太快会导致接收方来不及接收，导致数据的丢失

流量控制：就是让发送方的发送速率不要太快，既要让接收方来得及接收，也不要使网络发生拥塞

利用**可变窗口（rwnd）**进行流量控制举例

![image-20230608205825877](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608205825877.png)

#### 死锁

如果发送rwnd=400的报文段出现了丢失，就会造成**死锁局面**

为解决这个问题，TCP为每一个连接设置一个**持续计时器**：

- 只要 TCP 连接的一方收到对方的**零窗口**通知，就启动该持续计时器
- 若持续计时器设置的**时间到期**，就发送一个**零窗口探测报文段**（仅携带 1 字节的数据），而对方就在确认 这个探测报文段时给出了现在的窗口值
  - 若窗口仍然是零，则收到这个报文段的一方就重新设置持续计时器
  - 若窗口不是零，则死锁的僵局就可以打破了



### TCP拥塞控制

在某段时间，若对**网络中**某资源的需求超过了该资源所能提供的可用部分，网络的性能就要变坏。这种现象称为**拥塞 (congestion)**

拥塞引起的**重传并不会缓解网络的拥塞**（没有足够的缓存空间，分组被丢弃，结果重传，导致更多分组被丢弃）

**拥塞控制与流量控制的区别：**

- 拥塞控制	
  - 拥塞控制就是**防止过多的数据注入到网络**中，使网络中的路由器或链路不致过载
  - 拥塞控制所要做的都有一个前提，就是网络能够承受现有的网络负荷
  - **拥塞控制**是一个**全局性**的过程，涉及所有的主机、路由器、降低网络传输性能有关的所有因素
- 流量控制
  - **流量控制**往往指点对点通信量的控制，是个**端到端的问题**（接收端控制发送端）
  - 流量控制所要做的就是**抑制发送端发送数据的速率**，以便使接收端来得及接收



#### TCP的拥塞控制方法

TCP 采用**基于窗口的方法**进行拥塞控制。该方法属于**闭环控制**（基于反馈的，**开环控制**是指在设计网络的时候就考虑周到）方法

TCP发送方维持一个**拥塞窗口CWND**：

- 窗口大小取决于网络拥塞程度
- 发送端利用拥塞窗口来调整发送的数据量

拥塞的判断：

- 重传定时器超时
- 收到三个重复的ACK

**ＴＣＰ拥塞控制算法：**

- 慢开始
- 拥塞避免
- 快重传
- 快恢复



##### 慢开始

**算法的思路：由小到大逐渐增大拥塞窗口数值**

初始设置：

- 设置**初始拥塞窗口cwnd**（单位为报文段）
- **慢开始门限ssthresh（状态变量）**
  - 防止拥塞窗口cwnd增长过快导致网络拥塞

拥塞窗口 cwnd 控制方法：在每收到一个**对新的报文段的确认**后，可以把拥塞窗口增加最多一个 SMSS 的数值

`拥塞窗口cwnd每次的增加量 = min (N, SMSS) `

![image-20230608215343359](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608215343359.png)

**慢开始门限 ssthresh** 的用法如下:

- cwnd＜ssthresh，使用慢开始算法
- cwnd＞ssthresh，停止使用慢开始算法而改用**拥塞避免算法**
- cwnd=ssthresh，都可以使用



##### 拥塞避免算法

**思路：让拥塞窗口 cwnd 缓慢地增大，即每次cwnd加1，按照线性规律缓慢增长**



当网络出现拥塞时，无论在慢开始阶段还是在拥塞避免阶段，只要发送方判断网络出现拥塞**（重传定时器超时）**：

- `ssthresh=max(cwnd/2, 2)`（**此时cwnd是发生超时的时候的值**）
- `cwnd=1`
- 执行慢开始算法

![image-20230608220148756](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608220148756.png)



##### 快重传算法

采用快重传FR (Fast Retransmission) 算法可以让发送方**尽早知道发生了个别报文段的丢失**

**快重传算法**首先要求接收方不要等待自己发送数据时才进行捎带确认，而是要**立即发送确认**， 即使收到了失序的报文段也要立即发出对**已收到的报文段的重复确认**

![image-20230608220357456](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608220357456.png)

**发送方只要一连收到三个重复确认**，就知道接收方确实没有收到报文段，因而应当**立即进行重传（即“快重传”）**，这样就不会出现超时， 发送方也不就会误认为出现了网络拥塞



##### 快恢复算法

当发送端收到连续三个重复的确认时，由于发送方现在认为网络很可能**没有发生拥塞**，因此现在不执行慢开始算法，而是执行**快恢复算法** FR (Fast Recovery) 算法：

- 慢开始门限ssthresh=当前拥塞窗口cwnd/2
- 新拥塞窗口cwnd=慢开始ssthresh
- 开始执行拥塞避免算法

![image-20230608220624888](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608220624888.png)



##### 加法增大，乘法减小 (AIMD)

可以看出，在**拥塞避免阶段**，拥塞窗口是按照线性规律增大的。这常称为**“加法增大”** AI  (Additive Increase)。

当**出现超时或3个重复的确认**时，就要把**门限值**设置为当前**拥塞窗口值的一半**，并**大大减小拥塞窗口的数值**。这常称为“**乘法减小**”MD  (Multiplicative Decrease)



### TCP运输连接

TCP是面向连接的协议，所以运输连接有三个阶段：

- 连接建立
- 数据传输
- 连接释放

TCP连接的建立采用客户（主动发起连接方）-服务器（被动等待连接方）方式



##### 连接建立

TCP采用**三报文握手协议**建立连接（请想象两条数据流）

**SYN要设置为1**

![image-20230608221340516](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608221340516.png)

![image-20230608221348670](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608221348670.png)

![image-20230608221428992](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608221428992.png)

![image-20230608221452478](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608221452478.png)

![image-20230608223653907](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608223653907.png)

##### 连接释放

TCP 的连接释放：采用**四报文握手**

**FIN要设置为1**

![image-20230608221644646](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608221644646.png)

![image-20230608221703245](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608221703245.png)

![image-20230608221729326](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608221729326.png)

![image-20230608221739216](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608221739216.png)

![image-20230608221800662](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608221800662.png)

![image-20230608223705848](C:\Users\Jerry\AppData\Roaming\Typora\typora-user-images\image-20230608223705848.png)